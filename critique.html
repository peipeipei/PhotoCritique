<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="photopage.css">
    <link rel="stylesheet" type="text/css" href="critique.css">
    <link rel="stylesheet" type="text/css" href="vertical_navbar.css">
        <link href='http://fonts.googleapis.com/css?family=Redressed' rel='stylesheet' type='text/css'>
    <title>Critique for Bunny and Chicks</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
      <script src="https://cdn.firebase.com/js/client/2.2.4/firebase.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Quattrocento+Sans' rel='stylesheet' type='text/css'>
    
    
    <script type="text/javascript">
        var annotationsRef = new Firebase("https://6813-aperture.firebaseio.com/annotations");
        var commentsRef = new Firebase("https://6813-aperture.firebaseio.com/comments");

    	$(document).ready(function(){
            var offsetLeft = $("#photo").offset().left;
            var offsetTop = $("#photo").offset().top;
            var current_id = 0;
            var circle_list = [];

            annotationsRef.once("value", function(snapshot) {
                snapshot.forEach(function(data) {
                    var annotation = data.val();

                    if (annotation.currentID > current_id){
                        current_id = annotation.currentID;
                    }
                    displayCircle(annotation.className, data.key(), annotation.left, annotation.top, annotation.currentID);
                })
            });

            commentsRef.once("value", function(snapshot){
                snapshot.forEach(function(data){
                    var comment = data.val();
                    displayComment(comment.commentID, comment.text);
                })
            });

            function displayCircle(className, id, xPos, yPos, current){
                var img = document.createElement("img");
                img.className = className;
                img.src = "circle-faded.png";
                img.id = id;

                img.style.position = "absolute"
                img.style.left = xPos + "px";
                img.style.top = yPos + "px";

                if (!circle_list[current]){
                    circle_list[current] = []
                }
                circle_list[current].push(img);

                $("#photo").append(img);
            }

        $("#image").on("click", function(e){
            if ($("#annotate").hasClass("active")){
                var img = document.createElement("img");
                img.className = "circle img_" + current_id;
                img.src = "circle.png";
                var w = img.width;

                // center image on mouse click
                xPos = e.pageX - offsetLeft - w/2;
                yPos = e.pageY - offsetTop - w/2;

                img.style.position = "absolute"
                img.style.left = xPos + "px";
                img.style.top = yPos + "px";

                circle_list[current_id].push(img);

                $("#photo").append(img);

                var annotationRef = annotationsRef.push({
                    className: img.className,
                    currentID: current_id,
                    radius: w,
                    left: xPos,
                    top: yPos
                });
                img.id = annotationRef.key();

                //$("#annotate").removeClass("active");
                //$(document.body).css({'cursor' : 'default'});  
            }
        })

        $("#add_comment").on("click", function(){
            current_id++;
            var comment = document.createElement("div");
            $(comment).addClass("comment");
            comment.id = "comment_" + current_id;

            var textarea = document.createElement("textarea");
            textarea.id = "text_" + current_id;
            $(comment).append(textarea);

            var new_div = '<div class = "btn-toolbar"><button id = "annotate" class = "annotate btn btn-default" title = "Add annotation"><img src="circle-small.png"></button><button class = "cancel btn btn-danger pull-right" id = "cancel_' + current_id + '">Cancel</button><button class = "post btn btn-danger pull-right" id = "post_' + current_id + '">Post Comment</button></div>'

            $(comment).append(new_div);

            $("#comments").append(comment);

            $(this).attr("disabled", true);

            circle_list[current_id] = []
        })

        $(document).on("click", ".cancel", function() {
            var id = this.id.substring(7);
            $(".img_" + id).remove();
            $("#comment_" + id).remove();
            circle_list[current_id] = [];
            current_id--;

            $("#annotate").removeClass("active");
            $(document.body).css({'cursor' : 'default'}); 
            $("#add_comment").attr("disabled", false);
        })

        $(document).on("click", ".post", function() {
            var id = this.id.substring(5);
            var msg = $("#text_" + id).val();
            $("#comment_" + id).remove();

           var comment = document.createElement("div");
            $(comment).addClass("comment");
            comment.id = "comment_" + current_id;

            icons = '<span id="delete_' + id + '" class="delete glyphicon glyphicon-remove"></span>'
            $(comment).append(msg);
            $(comment).append(icons);

            $("#comments").append(comment);
            $(comment).addClass("active");

            //displayComment("comment_" + id, msg);

            $("#annotate").removeClass("active");
            $(document.body).css({'cursor' : 'default'});  
            $("#add_comment").attr("disabled", false);

            commentsRef.push({
                commentID: comment.id,
                text: msg,
            });

        })

        $(document).on("click", ".delete", function(){
            var id = this.id.substring(7);
            $("#comment_" + id).remove();
            $(".img_" + id).remove();

            commentsRef.orderByChild("commentID").equalTo("comment_" + id).on("value", function(snapshot) {
                 snapshot.forEach(function(data) {
                    var key = data.key();
                    commentsRef.child(key).remove();
                })
            });

            annotationsRef.orderByChild("className").equalTo("circle img_" + id).on("value", function(snapshot){
                snapshot.forEach(function(data){
                    var key = data.key();
                    annotationsRef.child(key).remove();
                })
            })
        })

        function displayComment(commentID, msg){
            var comment = document.createElement("div");
            $(comment).addClass("comment");
            comment.id = commentID;
            icons = '<span id="delete_' + commentID.substring(8) + '" class="delete glyphicon glyphicon-remove"></span>'
            $(comment).append(msg);
            $(comment).append(icons);

            $("#comments").append(comment);  
        }

        function activate(id, state){
            $('.comment').each(function(i, obj) {
                photo_id = obj.id.substring(8);
                if (id === photo_id){
                    if (state != "none"){
                        $("#" + obj.id).addClass(state);
                        circle_list[photo_id].forEach(function(circle){
                            circle.src = "circle.png"
                        })
                    }
                    else{
                       $("#" + obj.id).removeClass("hover");
                       console.log($(this))
                        if ($(this).hasClass("active")){
                            circle_list[photo_id].forEach(function(circle){
                                circle.src = "circle.png"
                            })
                        }
                        else {
                            circle_list[photo_id].forEach(function(circle){
                                circle.src = "circle-faded.png"
                            })    
                        }
                    }
                }
                else {
                    $("#" + obj.id).removeClass(state);

                    if (!$(this).hasClass("active")){
                        circle_list[photo_id].forEach(function(circle){
                            circle.src = "circle-faded.png"
                        })
                    }
                }
            });  
        }
        $(document).on("mouseover", ".circle", function(){
            var id = this.className.substring(11);
            activate(id, "hover");
        })

        $(document).on("mouseout", ".circle", function(){
            var id = this.className.substring(11)
            activate(id, "none");
        })

        $(document).on("click", ".circle", function(){
            var id = this.className.substring(11);
            activate(id, "active");
        })

        $(document).on("mouseover", ".comment", function(){
            var id = this.id.substring(8);
            activate(id, "hover");
        })

    	$(document).on("click", ".comment", function(){
    		var id = this.id.substring(8)
            activate(id, "active");
    	})

        $(document).on("mouseout", ".comment", function(){
            var id = this.id.substring(8)
            activate(id, "none");
        })

        $(document).on("click", "#annotate", function(){
            if ($(this).hasClass("active")){
                $(this).removeClass("active");
                $(document.body).css({'cursor' : 'default'});     
            }
            else {
                $(this).addClass("active");
                $(document.body).css({'cursor' : 'url("circle.png"), auto'});     
            }
        })

        $("#send_message").on("click", function(){
            window.location = "inbox.html";
        })

    	})
    </script>
</head>
<body>
   <nav class="navbar navbar-default" role="navigation">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>    
        </div>
        <!--<div class="navbar-collapse collapse">-->
            <ul class="nav navbar-nav navbar-left">
                <li><a href="gallery1.html"><img src = "logo_header.png"/></a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="gallery1.html" class="glyphicon glyphicon-user" title="Your Profile"> pikachu</a></li>
                <li><a href="inbox.html" class="glyphicon glyphicon-inbox" title="Inbox"></a></li>
                <li><a href="#" class="glyphicon glyphicon-cloud-upload" title="Upload"></a></li>
                <li><a href="#" class="glyphicon glyphicon-globe" title="Explore"></a></li>
            </ul>
        <!--</div>-->
    </nav>

<div id = "overall_container">    
<div id = "inbox">
<ul>
<li><a href = "inbox.html" style="font-weight: bold">Inbox (5)</a></li>
<li><a href = "#">Sent Critiques</a></li>
<li><a href = "critique.html">Drafts</a></li>
<li><a href = "#">Starred</a></li>
</ul>
</div>
<div id = "container">
    <div style="border-bottom: 2px solid #FF4242; font-family: Trebuchet MS; font-size: 20px">
<form class="form-horizontal">
  <div class="form-group">
    <label for="inputEmail3" class="col-sm-2 ">Subject: </label>
    <div class="col-sm-10">
      <input type="email" class="form-control" id="inputEmail3" value = "Re: Bunny and Chicks">
    </div>
  </div>
  <div class="form-group">
    <label for="inputPassword3" class="col-sm-2 ">To: </label>
    <div class="col-sm-10">
      bunnymaster
    </div>
  </div>
</form>
</div>
<div id = "photo">
    <h3>Title: Bunny and Chicks <span class="glyphicon glyphicon-question-sign pull-right" title = "Help"></span></h3>
    <!--<img id = "image" src="annotated_photos/cute-animals-group0.jpg" style="width:512px;"/>-->
    <img id = "image" src="gallery_photos/cute-animals.jpg" style = "width: 512px;"/>
    <div>
        <h3>Overall Comments:</h3>
        <textarea style="width: 518px; height:150px">Great job! I really like the photo. Just work on a few things =)</textarea>
        <div class="btn-toolbar"><button id = "send_message" class="btn btn-danger">Send</button> 
        <button class="btn btn-default pull-right"><span title = "Delete" class="glyphicon glyphicon-trash"></span></button>
        <button class="btn btn-default pull-right"><span title = "Save as Draft" class="glyphicon glyphicon-save"></span></button>
    </div>
    </div>
    <!--<div><button id = "annotate" class = "btn btn-default" title = "Add annotation"><img src="circle.png"></button>
    <button id = "group" class = "btn btn-default"  title = "Group circles"><img src="circle-group.png"></button></div>-->
</div>
<div id = "comments">
	<h3> Focal Points <button id = "add_comment" title="Add a comment and annotations" class = "btn btn-default pull-right"><span class="glyphicon glyphicon-plus"></span></button></h3>
	<!--<div class = "comment active" id="comment_1">
		These areas are in the shadow and I think they would look better if they were in light.
	</div>
	<div class = "comment" id = "comment_2">
		Great focus! I love how the whiskers and fur stand out!
	</div>
	<div class = "comment" id = "comment_3">
		I like how the background is blurred so the animals stand out.
	</div>-->
</div>
</div>
</div>


</body>
</html>